<!DOCTYPE html>
<html>
  <head>
    <title>Key Value Editor Widget</title>
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3/dist/cf-extension-api.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/contentful-ui-extensions-sdk@3/dist/cf-extension.css" />
    <style media="screen">
      body{
        margin: 0;
      }
      .item{
        width: 100%;
        display: flex;
      }
      .input{
        flex: 1;
      }
      .input--key{

      }
      .input--value{
        margin-left: 10px;
        flex: 3;
      }
      .delete-button{
        border: none;
        background: transparent;
        padding: 0 20px;
        border-radius: 2px;
        color: rgba(0,0,0,.6);
        cursor: pointer;
        transition: all .35s ease;
      }
      .delete-button cf-icon{
        pointer-events: none;
      }
      .delete-button:hover{
        color: rgba(0,0,0,.8);
        background: rgba(0,0,0,.1);
      }
    </style>
  </head>
  <body>
    <template id="item">
      <div class="item cf-form-field">
        <input type="text" placeholder="Name" class="cf-form-input input input--key"/>
        <input type="text" placeholder="Value" class="cf-form-input input input--value"/>
        <button data-purpose="delete" class="delete-button">
          <cf-icon name="delete">
            <svg width="14" height="14" viewBox="-1 -1 16 16" xmlns="http://www.w3.org/2000/svg"><g fill="currentColor"><path d="M4.846 7l-3.77-3.77L0 2.155 2.154 0 3.23 1.077 7 4.847l3.77-3.77L11.845 0 14 2.154 12.923 3.23 9.153 7l3.77 3.77L14 11.845 11.846 14l-1.077-1.077L7 9.153l-3.77 3.77L2.155 14 0 11.846l1.077-1.077z"></path></g></svg>
          </cf-icon>
        </button>
      </div>
    </template>
    <div class="items">

    </div>
    <button class="cf-btn-secondary" data-purpose="add">Add Item</button>

    <script type="text/javascript">
      let cfExt = window.contentfulExtension || window.contentfulWidget

      cfExt.init(initContentfulKeyValueEditor)
      function initContentfulKeyValueEditor (cfApi) {
        // start autoresiser
        cfApi.window.startAutoResizer();

        let itemTemplate = document.querySelector('#item')
        let items = document.querySelector('.items')
        // add initial item
        let fields = cfApi.field.getValue()
        fields.forEach( item => {
          let clone = document.importNode(itemTemplate.content, true)
          let inputs = clone.querySelectorAll("input")
          inputs[0].value = item.name
          inputs[1].value = item.value
          items.appendChild(clone)
        })

        // on change
        items.addEventListener('keyup', (e) => {
          validateAndSave()
        }, true)
        // delete items on x click
        items.addEventListener('click', (e) => {
            if (e.target.getAttribute('data-purpose') === 'delete') {
              let item = e.target.closest(".item")
              item.remove()
              cfApi.window.updateHeight();
              validateAndSave()
              items.dispatchEvent(new CustomEvent('updated', { detail: {
                itemCount: items.querySelectorAll('.item').length
              } }))
            }
        })
        // add item on add button click
        document.querySelector('[data-purpose=add]').addEventListener('click', (e) => {
          items.appendChild(document.importNode(itemTemplate.content, true))
          cfApi.window.updateHeight();
        })
        // add item if 0 left
        items.addEventListener('updated', e => {
          if (e.detail.itemCount === 0) {
            items.appendChild(document.importNode(itemTemplate.content, true))
            cfApi.window.updateHeight();
          }
        })

        var validateAndSave = debounce(function () {
          let currentJSON = []
          items.querySelectorAll('.item').forEach(item => {
            console.log(item, item.querySelector('.input--key'))
            let key = item.querySelector('.input--key').value
            let value = item.querySelector('.input--value').value
            if (key !== "" || value !== "")
            currentJSON.push({
              name: key,
              value: value
            })
          })
          cfApi.field.setValue(currentJSON)
        }, 150);

        // http://davidwalsh.name/javascript-debounce-function
        function debounce (func, wait) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                var later = function () {
                    timeout = null;
                    func.apply(context, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (!timeout) func.apply(context, args);
            };
        }
      }
    </script>

  </body>
</html>
